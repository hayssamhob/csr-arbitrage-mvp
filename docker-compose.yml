version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Infrastructure Services
  # ---------------------------------------------------------------------------

  # Message Bus (Redis Streams)
  redis:
    image: redis:7-alpine
    ports:
      - "127.0.0.1:6379:6379" # Bind to localhost only
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - redis_data:/data
    restart: always

  # Timeseries Database (TimescaleDB)
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    ports:
      - "127.0.0.1:5432:5432" # Bind to localhost only
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=trading_bot
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
    restart: always

  # UI / Visualization (Optional, useful for debugging DB)
  pgadmin:
    image: dpage/pgadmin4
    ports:
      - "127.0.0.1:5050:80" # Bind to localhost only
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@admin.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
    depends_on:
      - timescaledb
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------

  # Backend API Aggregator
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - PORT=8001
      - LBANK_GATEWAY_URL=http://lbank-gateway:3001
      - LATOKEN_GATEWAY_URL=http://latoken-gateway:3003
      - UNISWAP_QUOTE_URL=http://uniswap-v4-gateway:3002
      - STRATEGY_ENGINE_URL=http://strategy:3005
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - CEX_SECRETS_KEY=${CEX_SECRETS_KEY}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY}
      - RPC_URL=${RPC_URL}
    ports:
      - "8001:8001"
    depends_on:
      - redis
      - lbank-gateway
      - latoken-gateway
      - uniswap-v4-gateway
      - strategy
    restart: always

  # Market Data Gateway (LBank -> Redis)
  lbank-gateway:
    build:
      context: .
      dockerfile: ./services/lbank-gateway/Dockerfile
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SYMBOLS=csr_usdt,csr25_usdt
      - HTTP_PORT=3001
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - CEX_SECRETS_KEY=${CEX_SECRETS_KEY}
    ports:
      - "127.0.0.1:3001:3001"
    depends_on:
      redis:
        condition: service_healthy
    restart: always

  # Market Data Gateway (Latoken -> Redis)
  latoken-gateway:
    build:
      context: .
      dockerfile: ./services/latoken-gateway/Dockerfile
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SYMBOLS=CSR/USDT
      - HTTP_PORT=3003
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - CEX_SECRETS_KEY=${CEX_SECRETS_KEY}
    ports:
      - "127.0.0.1:3006:3003"
    depends_on:
      redis:
        condition: service_healthy
    restart: always

  # Uniswap V4 Gateway (Redis <-> V4 PoolManager)
  uniswap-v4-gateway:
    build:
      context: .
      dockerfile: ./services/uniswap-quote/Dockerfile
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - RPC_URL=${RPC_URL}
      - PRIVATE_KEY=${PRIVATE_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - CEX_SECRETS_KEY=${CEX_SECRETS_KEY}
      - HTTP_PORT=3002
    ports:
      - "127.0.0.1:3002:3002"
    depends_on:
      redis:
        condition: service_healthy
    restart: always

  # Strategy Engine (Redis -> Logic -> Redis)
  strategy:
    build:
      context: .
      dockerfile: ./services/strategy/Dockerfile
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - EXECUTION_MODE=dry-run
      - HTTP_PORT=3005
    ports:
      - "127.0.0.1:3003:3005"
    depends_on:
      redis:
        condition: service_healthy
    restart: always

volumes:
  redis_data:
  timescaledb_data:
